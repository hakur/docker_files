FROM composer:2.4.0 as composer
WORKDIR /cve
COPY composer.json composer.json
RUN composer config -g repo.packagist composer https://mirrors.aliyun.com/composer
RUN composer install

FROM golang:1.19.0 as gomod
WORKDIR /cveproj
ENV GOPATH=/cve
COPY go.mod go.mod
RUN go env -w GOPROXY=https://goproxy.cn,direct
RUN go get github.com/beego/beego@v1.7.0
RUN go get github.com/satori/go.uuid@v1.0.0
RUN go get github.com/gin-gonic/gin@v1.3.0
RUN go get github.com/argoproj/argo-cd@v1.6.0

FROM node:18.7.0-alpine3.16 as npm
WORKDIR /cve
RUN npm install -g cnpm --registry=https://registry.npm.taobao.org
COPY npm-packages.json package.json
RUN cnpm install

FROM rust:1.63.0-alpine3.16 as cargo
WORKDIR /cve
ENV RUSTUP_DIST_SERVER="https://mirrors.ustc.edu.cn/rust-static"
ENV RUSTUP_UPDATE_ROOT="https://mirrors.ustc.edu.cn/rust-static/rustup"
RUN cargo new binproj --bin && cargo new libproj --lib
COPY cargo.config ~/.cargo/config

WORKDIR /cve/binproj
COPY Cargo.toml Cargo.toml
RUN cargo update

WORKDIR /cve/libproj
COPY Cargo.toml Cargo.toml
RUN cargo update

FROM ubuntu:20.04
WORKDIR /cve
RUN mkdir php && mkdir rust && mkdir gomod && mkdir npm
COPY --from=composer /cve/* php
COPY --from=gomod /cve/* gomod
COPY --from=gomod /cveproj/go.mod gomod
COPY --from=cargo /cve/* cargo
COPY --from=npm /cve/* npm