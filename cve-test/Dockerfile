FROM composer:2.4.0 as composer
WORKDIR /cve
COPY composer.json composer.json
RUN composer config -g repo.packagist composer https://mirrors.aliyun.com/composer
RUN composer install

FROM golang:1.19.0 as gomod
WORKDIR /cveproj
ENV GOPATH=/cve
COPY go.mod go.mod
RUN go env -w GOPROXY=https://goproxy.cn,direct
RUN go mod download

FROM node:18.7.0-alpine3.16 as npm
WORKDIR /cve
RUN npm install -g cnpm --registry=https://registry.npm.taobao.org
COPY npm-packages.json package.json
RUN cnpm install
RUN cnpm install yui@3.10.2 yar@2.1.0 whereis@0.3.0 validator@1.0.0
COPY rename-copy-npm-json.sh rename-copy-npm-json.sh
RUN source rename-copy-npm-json.sh && \
    mkdir /cvejson && \
    ls /cve && \
    copy_and_rename_package_json_files "/cve/node_modules" "/cvejson"

FROM rust:1.63.0-alpine3.16 as cargo
WORKDIR /cve
ENV RUSTUP_DIST_SERVER="https://mirrors.ustc.edu.cn/rust-static"
ENV RUSTUP_UPDATE_ROOT="https://mirrors.ustc.edu.cn/rust-static/rustup"
RUN cargo new binproj --bin && cargo new libproj --lib
COPY cargo.config ~/.cargo/config

WORKDIR /cve/binproj
RUN mkdir .cargo
COPY cargo.config .cargo/config
COPY Cargo.toml Cargo.toml
RUN cargo update

WORKDIR /cve/libproj
RUN mkdir .cargo
COPY cargo.config .cargo/config
COPY Cargo.toml Cargo.toml
RUN cargo update

FROM fastlanetools/fastlane as fastlane

FROM alpine:3.10
WORKDIR /cve
RUN mkdir php && mkdir cargo && mkdir gomod && mkdir npm
COPY --from=composer /cve/composer.json php
COPY --from=composer /cve/composer.lock php
# COPY --from=gomod /cve/* gomod
# COPY --from=gomod /cveproj/* gomod
COPY --from=cargo /cve/* cargo
COPY --from=npm /cvejson/* npm
COPY NewtonsoftJson.dotnet.deps.json /cve/NewtonsoftJson.dotnet.deps.json
COPY fastlane.gemspec /cve/fastlane.gemspec
COPY Gemfile /cve/Gemfile
COPY Gemfile.lock /cve/Gemfile.lock
COPY go.mod go.mod
COPY go.sum go.sum
COPY go-bpfmon go-bpfmon

COPY gradle-happy.lockfile gradle-happy.lockfile
RUN mkdir -p maven/src
COPY pom.xml maven/pom.xml
COPY test.jar maven/test.jar

RUN chmod -x go.sum && chmod -x go.sum && chmod +x go-bpfmon && \
    chmod -x maven/pom.xml && \
    chmod -x maven/test.jar
COPY --from=fastlane /usr/local/lib/ruby/gems /usr/local/lib/ruby/gems